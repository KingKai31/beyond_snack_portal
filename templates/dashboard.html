{% extends "base.html" %}
{% block content %}

<style>
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 14px;
    margin-bottom: 20px;
  }

  .kpi-card {
    background: white;
    padding: 16px;
    border-radius: 14px;
    text-align: center;
    box-shadow: 0 6px 16px rgba(0,0,0,0.06);
  }

  .kpi-value {
    font-size: 1.8rem;
    font-weight: bold;
    margin-top: 6px;
  }

  .chart-box {
    background: white;
    padding: 14px;
    border-radius: 14px;
    margin-bottom: 18px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.06);
  }

  canvas {
    width: 100% !important;
    height: auto !important;
  }
</style>

<h1 class="title">ðŸ“Š Dashboard</h1>

<!-- KPI CARDS -->
<div class="kpi-grid">
  <div class="kpi-card">
    <span class="mdi mdi-check-circle-outline mdi-24px"></span>
    <div class="kpi-value" id="kpiPass">-</div>
    <div>Leak Pass %</div>
  </div>

  <div class="kpi-card">
    <span class="mdi mdi-gas-cylinder mdi-24px"></span>
    <div class="kpi-value" id="kpiOxy">-</div>
    <div>Avg Oâ‚‚</div>
  </div>

  <div class="kpi-card">
    <span class="mdi mdi-chart-bar mdi-24px"></span>
    <div class="kpi-value" id="kpiBreak">-</div>
    <div>Breakage %</div>
  </div>

  <div class="kpi-card">
    <span class="mdi mdi-alert-circle-outline mdi-24px"></span>
    <div class="kpi-value" id="kpiStop">-</div>
    <div>Top Stop</div>
  </div>
</div>

<!-- CHARTS -->
<div class="chart-box">
  <h3 class="subtitle">Leak Test (Pass / Fail)</h3>
  <canvas id="leakChart"></canvas>
</div>

<div class="chart-box">
  <h3 class="subtitle">Oxygen Trend</h3>
  <canvas id="oxyChart"></canvas>
</div>

<div class="chart-box">
  <h3 class="subtitle">Breakage Analysis</h3>
  <canvas id="breakChart"></canvas>
</div>

<div class="chart-box">
  <h3 class="subtitle">Stop Reasons</h3>
  <canvas id="stopChart"></canvas>
</div>

<script>
let leakChart, oxyChart, breakChart, stopChart;

async function loadDashboard() {
  try {
    const res = await fetch("/api/dashboard_data_v2", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({})
    });

    if (!res.ok) {
      throw new Error("Unauthorized or server error");
    }

    const data = await res.json();

    /* KPI */
    document.getElementById("kpiPass").innerText = data.kpi.pass_rate + "%";
    document.getElementById("kpiOxy").innerText = data.kpi.avg_oxygen;
    document.getElementById("kpiBreak").innerText = data.kpi.avg_breakage;
    document.getElementById("kpiStop").innerText = data.kpi.top_stop;

    /* CLEAN OLD CHARTS */
    [leakChart, oxyChart, breakChart, stopChart].forEach(c => {
      if (c) c.destroy();
    });

    /* LEAK */
    leakChart = new Chart(leakChartCanvas, {
      type: "bar",
      data: {
        labels: data.leak.date,
        datasets: [
          { label: "Pass", data: data.leak.pass, backgroundColor: "#48c774" },
          { label: "Fail", data: data.leak.fail, backgroundColor: "#f14668" }
        ]
      },
      options: { responsive: true }
    });

    /* OXYGEN */
    oxyChart = new Chart(oxyChartCanvas, {
      type: "line",
      data: {
        labels: data.oxygen.date,
        datasets: [{
          label: "Oxygen %",
          data: data.oxygen.oxygen,
          borderColor: "#3273dc",
          tension: 0.3
        }]
      },
      options: { responsive: true }
    });

    /* BREAKAGE */
    breakChart = new Chart(breakChartCanvas, {
      type: "bar",
      data: {
        labels: data.breakage.code,
        datasets: [
          { label: "Good", data: data.breakage.good, backgroundColor: "#48c774" },
          { label: "Broken", data: data.breakage.broken, backgroundColor: "#f14668" },
          { label: "Cluster", data: data.breakage.cluster, backgroundColor: "#ffdd57" },
          { label: "Residue", data: data.breakage.residue, backgroundColor: "#7957d5" }
        ]
      },
      options: { responsive: true }
    });

    /* STOP */
    stopChart = new Chart(stopChartCanvas, {
      type: "pie",
      data: {
        labels: data.stop.label,
        datasets: [{
          data: data.stop.count,
          backgroundColor: ["#ff3860","#ffdd57","#48c774","#3273dc","#7957d5"]
        }]
      }
    });

  } catch (err) {
    alert("Dashboard cannot load. Please login as boss.");
    console.error(err);
  }
}

/* Canvas refs */
const leakChartCanvas = document.getElementById("leakChart");
const oxyChartCanvas = document.getElementById("oxyChart");
const breakChartCanvas = document.getElementById("breakChart");
const stopChartCanvas = document.getElementById("stopChart");

loadDashboard();
</script>

{% endblock %}
